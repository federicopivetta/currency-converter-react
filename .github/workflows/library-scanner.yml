name: Library Scanner

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  scan-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft version
      
      - name: Scan dependencies
        run: |
          syft . -o json > sbom-raw.json
      
      - name: Setup Node.js for processing
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Process results into readable format
        run: |
          node << 'EOF'
          const fs = require('fs');
          
          const sbom = JSON.parse(fs.readFileSync('sbom-raw.json', 'utf8'));
          
          const libraries = sbom.artifacts.map(artifact => ({
            name: artifact.name,
            version: artifact.version,
            package_manager: artifact.type,
            file_path: artifact.locations?.[0]?.path || 'unknown',
          }));
          
          // Sort by file path then name
          libraries.sort((a, b) => {
            if (a.filePath !== b.filePath) {
              return a.filePath.localeCompare(b.filePath);
            }
            return a.name.localeCompare(b.name);
          });
          
          // Save as JSON
          fs.writeFileSync('libraries.json', JSON.stringify(libraries, null, 2));
    
      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-json
          path: libraries.json

