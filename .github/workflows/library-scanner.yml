name: Library Scanner

on:
  workflow_dispatch: # Permette di avviare la scansione manualmente (tasto "Run workflow")

jobs:
  scan-dependencies: # Definisce un gruppo di attivitÃ  chiamato 'scan-dependencies'
    runs-on: ubuntu-latest # Usa una macchina virtuale Linux aggiornata fornita da GitHub
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # Scarica il codice del progetto sulla macchina virtuale
      
      - name: Install Syft # Scarica lo script ufficiale di installazione di Syft e lo esegue
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Scan and Generate Custom JSON # Analizza cartella (.)
        run: |
          syft dir:. \
            --exclude "**/package-lock.json" \
            --exclude "**/yarn.lock" \
            --exclude "**/pnpm-lock.yaml" \
            --exclude "**/poetry.lock" \
            --exclude "**/Pipfile.lock" \
            --exclude "**/composer.lock" \
            --exclude "**/node_modules/**" \
            -o json | jq '[.artifacts[] | {
              name: .name,
              version: .version,
              type: .type,
              path: (.locations[0].path // "unknown")
            }] | sort_by(.path, .name)' > libraries.json
      
      - name: Upload JSON report
        uses: actions/upload-artifact@v4 # Azione standard di GitHub per salvare file
        with:
          name: dependency-report
          path: libraries.json
